/**
 *******************************************************************************
 * @file    tempSensor.c
 * @author	Arham
 * @date    Oct 2024
 * @brief   The driver for the temperature sensing chip (P3T1755DP/Q900Z)
 *
 ******************************************************************************
 */

#include "tempSensor.h"

#include "bsp.h"
#include "debug.h"
#include "controlStateMachine.h"
#include "watchdog.h"

/*********************************************************************************************************************/
/*------------------------------------------------Function Prototypes------------------------------------------------*/
/*********************************************************************************************************************/

/*********************************************************************************************************************/
/*------------------------------------------------------Macros-------------------------------------------------------*/
/*********************************************************************************************************************/

/*********************************************************************************************************************/
/*-------------------------------------------------Global variables--------------------------------------------------*/
/*********************************************************************************************************************/

/*********************************************************************************************************************/
/*------------------------------------------------Function Definition------------------------------------------------*/
/*********************************************************************************************************************/

/*********************************************************************************************************************/
/*-------------------------------------------------------Task--------------------------------------------------------*/
/*********************************************************************************************************************/

void tempSensorTask(void *pvParameters)
{
    if (registerTaskToWatch(TEMP_SENSOR_TASK_ID, 2*TEMP_SENSOR_TASK_INTERVAL_MS, false, NULL) != HAL_OK)
    {
        ERROR_PRINT("Failed to register power task with watchdog!\n");
        Error_Handler();
    }

    /* TODO: initialize the sensor (write config register if needed) */

    TickType_t xLastWakeTime = xTaskGetTickCount();
    while (1)
    {
        /* TODO: reading and report temperature*/

        /* Send CAN Message */

        watchdogTaskCheckIn(TEMP_SENSOR_TASK_ID);
        vTaskDelayUntil(&xLastWakeTime, TEMP_SENSOR_TASK_INTERVAL_MS);
    }
}